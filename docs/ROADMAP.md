# Factory Simulator v1 — 진행 단계 계획 (로드맵)

명세서([factory_simulator_v_1_작업_명세서.md](factory_simulator_v_1_작업_명세서.md))와 현재 구현을 기준으로, **사용자 요구사항**과 **추가로 필요한 기술 요소**를 합쳐 정리한 진행 계획입니다.

---

## 1. 현재까지 완료된 범위

| 구분 | 내용 |
|------|------|
| **배치** | 단일 Zone 그리드, 입고/출고/컨베이어/명세서 기계(정련로·분쇄기 등)/전력공급기 배치·이동·삭제·일괄 선택 |
| **컨베이어** | 진입/진출 방향(화살표), 직선 연속 배치, 경로 계산 반영 |
| **창고** | 품목별 재고 숫자 입력, 출고 품목 선택 |
| **테스트** | 물품 1개 흐름(출고→입고) 경로 시연 |
| **UI** | 확대/축소·팬, 전력 공급 범위 표시, 색감·대비 정리, 슬롯·버전 저장 |
| **데이터** | LayoutMap, PlacedEquipment, EquipmentKind·스펙(명세 §4), 타입·스펙 정렬 |

---

## 2. 사용자 요구사항 (추가로 해야 할 것)

1. **실제 재료 수집량 + 기계별 레시피 적용**
   - 창고/라인에서 들어오는 **재료 수집량**을 반영하고,
   - **각 기계에 레시피를 적용**해 어떤 입력 → 어떤 출력·수량·시간으로 동작할지 정의.

2. **전체 물품 생산량·소비량·생산속도 관리 패널**
   - 품목별 **생산량/소비량**, **생산속도(처리량)** 등을 한 화면에서 보고 관리할 수 있는 **관리 패널** 도입.

3. **전력 사용량·재료 변환비율·시간 등 보조 요소**
   - **전력 사용량**(소비/공급),
   - **재료 변환비율**(입력 N개 → 출력 M개),
   - **처리 시간**(process_time_sec) 등을 1·2번을 보조하는 데이터·UI로 다루기.

4. **실제 시뮬레이션 환경에 가까운 시뮬레이션 기능**
   - 시간이 흐르는 **tick 기반** 실행,
   - 컨베이어 이동·기계 가공·입출고가 **명세서 순서**대로 동작하는 **시뮬레이션 모드** 추가.

---

## 3. 명세서·구현 관점에서 필요한 요소

- **Tick 모델** (§6): tick_sec 0.5초, 컨베이어 4 tick당 1칸 이동.
- **Tick 처리 순서** (§6.2): 출고 → 컨베이어 이동 → 기계 입력 흡입 → 기계 생산 진행 → 기계 출력 배출 → 입고.
- **레시피** (§4.4): 기계 타입별 복수 레시피, inputs/outputs 수량, process_time_sec.
- **기계 버퍼** (§4.5): 입력·출력 버퍼 크기 50, 레시피 조건 충족 시 작업 시작 → 시간 누적 → 완료 시 출력 버퍼 적재 → 출력 방향 비면 배출.
- **전력 판정** (§5.2): 기계가 전력 범위 내에 있으면 powered, 없으면 생산 중단(입력 허용·출력 중단).
- **컨베이어 규칙** (§3.2·3.4): 2초당 1칸, 다음 칸 비어 있을 때만 이동, tick 2단계(의사결정 → 충돌 없이 적용).

---

## 4. 통합 진행 단계 제안

### Phase A — 시뮬레이션 기반 (시간·데이터 모델)

**목표**: “시간이 흐르는” 시뮬레이션을 돌릴 수 있는 **엔진·데이터** 갖추기.

| 순서 | 항목 | 설명 |
|------|------|------|
| A-1 | **Tick 엔진** | current_tick, tick_sec(0.5), 매 tick마다 §6.2 순서로 처리하는 루프. 아직은 “실제 물품 이동” 없이 순서·호출만 확립. |
| A-2 | **컨베이어 위 아이템** | 셀별 “아이템 1개 여부” 상태. 출고/입고/기계와 연동해 아이템 생성·소비. |
| A-3 | **컨베이어 이동 로직** | 4 tick당 1칸, 다음 칸 비어 있을 때만 이동, 2단계(의사결정 → 적용). |
| A-4 | **창고 출고/입고 연동** | 출고: 창고에서 품목 1개 차감 후 해당 포트 셀에 아이템 생성. 입고: 입고 셀 도착 시 창고에 1개 적재 후 셀 비우기. |

**결과**: “재생” 시 창고·컨베이어·입출고만으로도 물품이 시간에 따라 움직이는 것까지 확인 가능.

---

### Phase B — 기계 생산·레시피·재료

**목표**: **실제 재료 수집량**과 **기계별 레시피**를 반영한 생산.

| 순서 | 항목 | 설명 |
|------|------|------|
| B-1 | **레시피 데이터** | 기계 타입별 레시피: inputs(item_id, 수량), outputs(item_id, 수량), process_time_sec. (명세 §4.4) |
| B-2 | **기계 상태 확장** | 기계별 active_recipe_id, in_buffer, out_buffer(최대 50), progress(초), powered. |
| B-3 | **기계 tick 처리** | 입력 버퍼가 레시피 조건 충족 시 작업 시작 → progress 누적 → 완료 시 출력 버퍼 적재 → 출력 방향 컨베이어 비면 1개 배출. |
| B-4 | **전력 판정** | 전력공급기 12×12 범위 내 기계만 powered=true. 미공급 시 생산 진행 중단(출력만 중단). |
| B-5 | **기계별 레시피 선택 UI** | 배치 모드에서 기계 선택 시 “활성 레시피” 선택. (1번 요구사항 반영) |

**결과**: 재료가 들어오면 레시피에 따라 기계에서 변환되고, 수집량·레시피가 실제 생산에 반영됨.

---

### Phase C — 관리 패널·지표 (생산량·소비량·속도)

**목표**: **전체 물품 생산량/소비량/생산속도**를 보는 **관리 패널** 도입. (2번 요구사항)

| 순서 | 항목 | 설명 |
|------|------|------|
| C-1 | **누적 통계 수집** | 품목별: 창고 입고 누적, 출고 누적, 기계별 생산(출력) 누적·소비(입력) 누적. (tick 또는 이벤트 단위) |
| C-2 | **관리 패널 UI** | 품목별 생산량·소비량·현재 창고 재고, (선택) 생산속도(분당/시간당). 새 패널 또는 기존 우측/하단 영역 활용. |
| C-3 | **생산속도·병목** | 시간당 처리량, 평균 대기 시간 등 간단 지표. (선택) 병목 구간 강조. |

**결과**: “어떤 품목이 얼마나 생산·소비되는지”, “속도는 어떤지” 한눈에 확인 가능.

---

### Phase D — 보조 요소 (전력·변환비율·시간)

**목표**: **전력 사용량·재료 변환비율·시간**을 1·2번을 보조하는 요소로 정리. (3번 요구사항)

| 순서 | 항목 | 설명 |
|------|------|------|
| D-1 | **전력 사용량** | 기계별 소비 전력(kW), (선택) 전력공급기 용량·총 소비량 표시. 관리 패널 또는 장비 속성에 표시. |
| D-2 | **변환비율·시간 노출** | 레시피의 입력 N → 출력 M, process_time_sec을 UI에 표시. (이미 데이터에 있으면 “노출” 위주) |
| D-3 | **시뮬 시간·속도 설정** | 시뮬레이션 실행 속도(1x, 2x 등), (선택) 시뮬 시간 상한. |

**결과**: 전력·비율·시간이 관리 패널·시뮬과 자연스럽게 연결됨.

---

### Phase E — 시뮬레이션 모드 완성 (실제 환경처럼)

**목표**: **실제 시뮬레이션 환경처럼** 재생/일시정지/구간 확인이 가능한 시뮬레이션 기능. (4번 요구사항)

| 순서 | 항목 | 설명 |
|------|------|------|
| E-1 | **시뮬 모드 화면** | 배치된 Zone 그리드 + 컨베이어/기계 상태(아이템 유무, 진행률 등) 시각화. (기존 배치 모드와 데이터 공유) |
| E-2 | **재생/일시정지/스텝** | 재생(실시간 tick 진행), 일시정지, 1 tick 스텝. |
| E-3 | **시뮬 설정** | 시뮬 시간 상한, 입고/출고 속도(또는 시나리오), 초기 창고 재고. |
| E-4 | **결과 요약** | 구간별/전체 생산량·소비량·평균 처리량 등 관리 패널 지표와 연동. |

**결과**: “실제처럼” 시간을 돌려 보면서 생산량·소비량·속도를 확인할 수 있는 시뮬레이션 모드 완성.

---

## 5. 요구사항 ↔ 단계 매핑

| 사용자 요구사항 | 반영 단계 |
|----------------|-----------|
| 1. 실제 재료 수집량 + 기계별 레시피 적용 | Phase B (레시피·버퍼·tick 처리), Phase A (입출고·컨베이어) |
| 2. 생산량·소비량·생산속도 관리 패널 | Phase C |
| 3. 전력 사용량·변환비율·시간 등 보조 요소 | Phase D, Phase B (전력·레시피 데이터) |
| 4. 실제 시뮬레이션 환경처럼 시뮬 기능 | Phase A + B + E (tick 엔진 + 기계 + 시뮬 UI) |

---

## 6. 권장 진행 순서 (의존성 반영)

1. **Phase A** → 시뮬레이션의 “시간·물품 이동” 기반.
2. **Phase B** → A 위에 기계·레시피·전력까지 붙여 “생산”이 돌아가게.
3. **Phase E (E-1·E-2)** → 재생/일시정지로 “시뮬 모드” 체감 가능.
4. **Phase C** → 관리 패널로 생산량·소비량·속도 확인.
5. **Phase D** → 전력·비율·시간 보조 표시.
6. **Phase E (E-3·E-4)** → 시뮬 설정·결과 요약으로 마무리.

(필요하면 C와 D의 순서는 바꿔도 됨.)

---

## 7. 문서·참고

- **명세서**: [factory_simulator_v_1_작업_명세서.md](factory_simulator_v_1_작업_명세서.md)
- **기능·슬롯 정리**: [FEATURES.md](FEATURES.md)
- **프로젝트·Phase 요약**: [PROJECT.md](PROJECT.md)

이 로드맵은 위 문서들과 함께 갱신하며 사용하면 됩니다.
