# 기능 정리 — 작업 환경·저장·버전·슬롯

현재 구현된 기능과, **작업 환경(저장·버전·슬롯)** 구조를 한곳에 정리한 문서입니다.

---

## 0. 진행 단계 및 검토

### 현재 단계
- **지금**: 프로젝트 동작이 이뤄지는 **전체 레이아웃 기반**을 만드는 단계.
- **레이아웃 기반**: 헤더(타이틀 + 모드 전환) → 작업영역 바(슬롯·저장 예정) → 본문(배치·테스트 / 시뮬레이션).  
  이 구조 위에 슬롯·저장·버전 UI를 단계적으로 추가합니다.

### 적용 여부 검토 (최근)

| 항목 | 상태 | 비고 |
|------|------|------|
| 3단 레이아웃 (헤더 / 작업영역 바 / 본문) | ✅ 적용 | App.tsx, App.css |
| Slot, SlotVersion, WorkspaceState 타입 | ✅ 적용 | src/models/types.ts |
| workspace 로컬 스토리지 (load/save/createSlot/updateSlot) | ✅ 적용 | src/workspace/ |
| GitHub 기준 logistics-sim, base 경로 | ✅ 적용 | vite.config.ts, README, docs/PROJECT.md |
| README(소개) vs docs(작업용) 분리 | ✅ 적용 | README.md, docs/PROJECT.md, FEATURES.md |
| 배치 모드 ↔ 슬롯 연동 | ✅ 적용 | App에서 workspace 연동, LayoutMode에 layout/onLayoutChange 전달 |

### 완료한 단계 (최근 작업)
1. **작업영역 바** `WorkspaceBar`: 슬롯 선택(select)·새 슬롯·저장·삭제 버튼.
2. **App**: workspace 상태(loadWorkspace 초기값), 현재 슬롯 derived, 저장 시 `saveWorkspace(workspace)` 호출.
3. **LayoutMode**: `layout`, `onLayoutChange` props로 현재 슬롯 배치 표시·편집, 변경 시 workspace 메모리 갱신 → **저장** 클릭 시 로컬 스토리지 반영.

### 완료한 단계 (슬롯 이름·버전)
- **슬롯 이름 편집**: 작업영역 바에서 슬롯 선택 후 ✎ 클릭 → 입력 후 Enter/Blur로 반영. `updateSlot(slot, { name })` 지원.
- **버전 저장**: 현재 슬롯 상태를 "버전"으로 저장 (버전 저장 버튼). 슬롯당 최대 20개 유지.
- **버전 목록·복원**: "버전 (N)" 클릭 시 목록 표시, 항목별 "복원"으로 해당 시점 layout으로 되돌림.

### 피드백 반영 (최근)
- **확대/축소**: 그리드 툴바에 − / 100% / + 로 25%～200% 줌. 셀 크기 조절로 여러 칸 한눈에 보기 가능.
- **그리드·기능 패널**: 웹 기준 그리드는 **정사각형 셀**(32px)로 고정, 전체 width 점령하지 않음. **상단**·**사이드**에 기능 패널 영역 추가(추후 활용).
- **장비**: 입고, 출고, 컨베이어, **기계1** 네 가지로 통일. (보관·가공은 타입 호환용 유지.)
- **GitHub Pages 배치·저장**: 슬롯이 없을 때 배치/저장이 무시되던 문제 → **슬롯 0개일 때 자동으로 "슬롯 1" 생성**하여 첫 방문·GH Pages에서도 배치·저장 가능.
- **버전 저장**: "버전 저장" 클릭 시 **즉시 로컬 스토리지에 반영** (별도 "저장" 버튼 불필요). GitHub Pages에서도 동일.
- **기본 그리드**: **32×32**로 설정. (신규 슬롯·빈 레이아웃 기준. 기존 저장 데이터는 기존 행/열 유지.)
- **컨베이어**: **연결**로 인지. **출력(내보내는) 방향** + **입력(받는) 방향** 분리 → 입력≠출력이면 **방향전환(코너)**. 클릭=출력 순환, 우클릭=입력 순환.
- **기계1**: 테스트 경로에 **포함**. 입고→컨베이어→기계1→…→출고 가능. 기계1은 **출력(가공 후 내보내는) 방향** 설정. (추후 다양한 재료·가공 형태 확장 예정.)

### 창고·관리 패널 (모달)
- **창고** 및 이후 추가될 **관리 패널**은 별도 페이지가 아닌 **모달(오버레이)** 로 표시.
- 배치 모드 툴바의 **「창고」** 버튼으로 창고 재고 수량 입력 모달 열기. 가시성 확보 및 다른 기능과 분리.

### 기계 기본 레시피·입장 규칙
- **기본 레시피**: 해당 기계의 레시피 중, **입력으로 들어오는 품목과 맞는 레시피**가 있으면 그 레시피를 자동 선택.
- **맞는 레시피가 없으면**: 해당 품목은 **입력 포트로 들어가지 않음** (시뮬레이션에서 입장 거부). 구현: `getDefaultRecipeIdForInput(machine_id, item_id)`.

### 기계 내부 표시
- 기계 선택 시 **기계 내부** 섹션: **입력 버퍼**, **출력 버퍼**, **변환 시간**(총 시간 및 현재 변환 중인 시간) 표시. (버퍼·현재 시간은 시뮬레이션 연동 시 실값 반영 예정.)

### 기계 입출력 포트 넘버링
- 기계는 **여러 개의 입·출력 포트**를 가지며, **각 포트는 동일한 작업**을 수행.
- **입·출력 포트를 넘버링(0, 1, 2, …)으로 관리**:
  - 입·출력 **순서 처리**가 쉬움.
  - **특정 포트만 열린 경우**에도 오류 없이 이동·경로 계산 가능.
- 구현: `equipmentSpecs`의 `inputPortCount`/`outputPortCount`, `pathUtils.getMachineOutputPortNextCells(layout, eq)`가 **포트 번호 순**으로 다음 셀 목록을 반환. 경로 구축 시 모든 출력 포트를 순서대로 시도해 연결 가능한 첫 포트로 진행.

### 향후 기계 사양 (인지)
- 기계는 추후 **기계별 크기**(그리드 칸 수), **입출력 포트 위치·개수** 등을 고정해 두고 확장할 예정. 당장 구현이 아니어도 설계 시 반영.

### 더미 시나리오 (간단 시나리오)
- **물품**: A, B, C (원자재) / A1, B1, C1 (가공품). 기계1 통과 시 A→A1, B→B1, C→C1.
- **기계1**: 2×2 크기, 한쪽 면 2입력·반대쪽 2출력, 방향전환 가능. 입력은 A,B,C만.
- **입고**: 어떤 물품이든 입고 → **창고**로 적재.
- **출고**: **창고**와 연결. 출고 포트에서 “창고 내 특정 물품”을 선택하면 해당 물품만 주기적으로 출력.
- **창고**: 입고에서 받은 물품 보관, 출고 포트별 선택 품목만 공급.
- 데이터: `src/data/dummyScenario.ts` (Phase 2 시뮬레이션에서 사용).

### 명세서 정렬 (최근)
- **기준 명세**: [factory_simulator_v_1_작업_명세서.md](factory_simulator_v_1_작업_명세서.md).  
- **명세–코드 매핑**: [SPEC_ALIGNMENT.md](SPEC_ALIGNMENT.md).  
- **타입 확장**: World, Zone, Warehouse, Port(1×3), TICK_SEC, CONVEYOR_TICKS_PER_MOVE, PowerProvider(2×2).  
- **데이터**: Zone 프리셋(Z1 70×70, Z2/Z3 40×40), `src/data/zonePresets.ts`.  
- 기존 LayoutMap/PlacedEquipment/슬롯 저장 호환 유지.

### 전체 구조 (설계 기준)
- **구조 문서**: [docs/STRUCTURE.md](STRUCTURE.md).  
  - **방향전환**: 한 셀에서 **진입 방향 ≠ 이탈 방향**(예: A2→A3→B3에서 A3의 동작).  
  - **다칸 장비**: position + size(예: 2×2), 점유 칸·겹침 검사.  
  - **입출력 포트**: 장비 종류별 스펙(어느 변·몇 개), `src/data/equipmentSpecs.ts`.  
  - **출고→입고 순서**: 출고에서 창고 물품 선택, 입고는 모두 창고 적재.

### Phase 1 완료 / Phase 2
- **Phase 1**: 물류 시스템의 **구조·작동·흐름**을 온전히 갖추는 단계. 테스트(물품 1개)와 시뮬레이션은 **같은 흐름 규칙**을 공유하므로, Phase 1에서 그 규칙(flow 모델)을 완성.
- **Phase 1 구현 완료**:  
  - **다칸 장비**: 기계1 2×2 배치·점유·겹침 검사(`getOccupiedCells`, `canPlaceAt`). 그리드에서 다칸 셀 클릭 시 동일 장비 선택.  
  - **출고**: 출고 장비 클릭 시 사이드바에서 **창고 물품 선택**(A/B/C/A1/B1/C1). 해당 품목만 해당 출고에서 나감.  
  - **입고**: 출고에서 시작한 테스트가 **입고** 셀에서 끝나면 창고에 1개 자동 적재.  
  - **컨베이어**: 한 셀에서 입력 방향 ≠ 출력 방향(방향전환) 유지.  
  - **기계**: 측면 입출력 포트(스펙), 2×2 점유, **물품별 소요 시간·변환 비율** 데이터(`MACHINE1_PROCESSING_MS`, `MACHINE1_CONVERSION_RATIO`).  
  - **테스트**: 「물품 1개 (입고→출고)」, 「물품 1개 (출고에서)」. 창고 수량은 사이드바에서 품목별 +1로 설정.
- **Phase 2**: 그 위에 시간축·처리량·대기 시간 지표·재생 UI 추가. 계획은 [docs/PROJECT.md](PROJECT.md) Phase 2 참고.

---

## 1. 현재 기능 (이미 구현된 것)

| 구분 | 내용 |
|------|------|
| **전체 레이아웃** | 헤더 → 작업영역 바(슬롯·이름 편집·저장·버전·삭제) → 본문 3단 구조 |
| **모드 전환** | 상단에서 「배치·테스트」 / 「시뮬레이션」 전환 |
| **배치·테스트** | 그리드: 입고/출고/컨베이어(입출력·방향전환)/기계1(출력 방향), 정사각형 셀·줌. **물품 1개 흐름** 테스트(기계1 경유) |
| **시뮬레이션** | 설명 + Phase 2 준비용 플레이스홀더 |
| **반응형** | 웹·모바일 공통 레이아웃, 뷰포트 대응 |
| **배포** | GitHub Pages (`/logistics-sim/`), GitHub Actions 자동 배포 |

---

## 2. 작업 환경이란 (목표)

- **한 사람이 여러 시나리오**를 각각 작업할 수 있고  
- **여러 사람이 각자 작업**할 수 있도록  
**저장·버전·슬롯**으로 구조를 나눕니다.

| 개념 | 설명 |
|------|------|
| **작업 환경** | 현재 선택된 슬롯 + 슬롯 목록 + (선택) 버전 히스토리 |
| **슬롯** | 배치/시나리오 하나를 담는 단위. 이름·배치·시뮬 설정 포함 |
| **저장** | 현재 슬롯의 배치·설정을 디스크(로컬 또는 서버)에 남김 |
| **버전** | 같은 슬롯 안에서 과거 저장 상태를 유지·복원 |

---

## 3. 슬롯 관리

- **슬롯** = 한 가지 “작업 공간” (예: A창고 배치, B창고 배치, 테스트용).
- 슬롯마다 **이름**, **생성/수정 일시**, **현재 배치(LayoutMap)**, **(선택) 시뮬 설정**을 가짐.
- 사용자 동작:
  - **슬롯 선택**: 작업할 슬롯을 고르면 해당 배치/설정이 화면에 로드됨.
  - **새 슬롯**: 빈 배치로 새 슬롯 생성 후 이름 지정.
  - **슬롯 삭제**: 필요 시 삭제 (확인 후).
  - **슬롯 복제**: 기존 슬롯을 복사해 새 슬롯으로 저장 (선택 기능).

저장소는 우선 **로컬(브라우저)** 기준으로 하고, 나중에 서버 연동 시 같은 데이터 구조를 사용할 수 있도록 설계.

---

## 4. 저장

- **저장** = 현재 선택된 슬롯의 `layout`(+ 필요 시 `simulationConfig`)을 영구 저장.
  - 1차: **로컬 스토리지** (같은 브라우저·같은 기기).
  - 이후: 서버 API 연동 시 해당 슬롯을 서버에 저장.
- **자동 저장**: 주기적 또는 “배치 변경 시” 자동 저장 옵션 (Phase 2 등에서 고려).
- **다른 이름으로 저장**: 현재 슬롯을 새 이름의 슬롯으로 복사해 저장 (슬롯 추가).

---

## 5. 버전 관리

- **버전** = 한 슬롯에 대해 “그 시점의 스냅샷”을 남긴 것.
- 각 버전: **저장 시각**, **선택 메모(라벨)**, **그 시점의 layout(및 설정)**.
- 사용자 동작:
  - **버전 만들기**: 현재 상태를 “버전”으로 남김 (이름/메모 선택).
  - **버전 목록 보기**: 해당 슬롯의 과거 버전 목록 조회.
  - **이전 버전으로 복원**: 선택한 버전을 현재 슬롯 상태로 되돌림.

**적용됨**: 버전 저장(`addVersion`), 버전 목록·복원 UI(작업영역 바 "버전 (N)" 드롭다운), 슬롯당 최대 20개 버전 유지.

---

## 6. 데이터 구조 요약

- **WorkspaceState**: `currentSlotId`, `slots[]`, (선택) `versionsBySlotId`
- **Slot**: `id`, `name`, `createdAt`, `updatedAt`, `layout`, `simulationConfig?`
- **SlotVersion**: `id`, `slotId`, `savedAt`, `label?`, `layout`, `simulationConfig?`

타입 정의는 `src/models/types.ts`, 저장/불러오기 골격은 `src/workspace/` 에 두었습니다.

---

## 7. UI 배치 (제안)

- **헤더 또는 사이드**: “현재 슬롯” 표시 + 슬롯 전환 드롭다운(또는 목록).
- 같은 영역 또는 툴바: **새 슬롯**, **저장**, **(Phase 2) 다른 이름으로 저장**, **(Phase 2) 버전 목록 / 복원**.
- 배치·테스트 / 시뮬레이션 모드는 **현재 슬롯의 데이터**를 기준으로 동작.

이렇게 하면 “작업 환경 + 저장 + 버전 + 슬롯”이 한 번에 정리되고, 여러 사람·여러 시나리오를 같은 앱에서 구분해 쓸 수 있습니다.
